# Recent Advances in HTTP and Controlling them using ruby

## HTTP2の現状

* 2015/5に標準化が確定
  * シェア:2015/5 18% -> 2016/5 30%に拡大
  * 合わせてHTTPのシェアが食われており, HTTP2未満になっている

### HTTP2の主要技術

* ヘッダーの圧縮(HPACK)
  * 問題なく順調に適用が進んでいる
  * 中央値で9割削減
* Concurrency
  * HTTP2の目玉
  * クライアント側が重みを設定するが，クライアントが設定しない場合があったり，サーバ側がうまく働かず，うまくいかない場合がある．
* Push
  * 賛否両論
    * 20%ぐらい速くなったという意見もあれば，逆に遅くなったという意見もある．
    * CDNのEdge ServerからのPushについては実装方法が未確定

### 理想

HPACKについては問題がないので，ここではConcurrencyとPushについてのみ述べる

#### Concurrency

* 優先順位が高い順番に送ってほしい．
  * TCP Layler でブロックされている場合がある．-> TCP Head of line blocking
* 正しい順番で送ってほしい
  * そもそもブラウザが未設定
  * 隠れたリソースがあると，うまくいかない

#### Push

* ないデータだけ送ってほしい．
  * 難しい問題．方法がまちまち

### TCP head of line

* TCPが一度に送れる(CWND)サイズは決まっている．

#### 普通のWeb Server

* CWNDサイズに関係なくデータを書き込んでしまう．
  * 送れなかった分はTCP Send Bufferに溜まってしまう．
* この状態で優先度の高いデータが要求されたとしても，TCP send bufferの末尾に追加される形になるので，データがなかなか送れてくれない．

##### 解決策

* HTTPサーバ側でCWNDサイズ(TCP_INFOからわかる)の分だけ書き込む．
  * 優先度の高い要求があったら，すぐに送れる状態にできる．
* バッファのステータスをOSを監視し，書き込み可能状態になったら書き込む．
  * latencyを減らす

### HTTP2の優先順位付け

* 重み付けとchaining
* 重みに応じて，バンド幅を変更する
  * まず，srcを見る
    * javascriptやcssが優勢順位高め
    * htmlは上のものと比べると圧倒的に優先順位が低い
    * html内を走査し，imageがあったらbodyより優先順序を低くする．
      * imageがなくてもレイアウトは構築できるため
* SafariやBlinkでは重み付けしてくれない
  * 全ての項目に同じ重み付け
    * ページの項目内では画像が一番多い
      * 画像の転送に帯域を取られてしまって却って遅くなる．
  * WFQ(Weighted Fair Queue)やDRR(Deficit Round Robin;不足ラウンドロビン)を使って，帯域を奪われないようにする工夫が必要

### 隠れリソース

CSSのリンクにイメージがあったり，JavascriptでHTMLを書いている場合，それらの処理もしてしまうため，レスポンスが悪くなる．

#### 対策

+ そもそも書かない
  + 隠れリソースは，HTTP/1, 2問わずアンチパターンである．
+ ``<rel preload>`` で明示的にロードする

##　Push

+ Javascriptや/CSSがあれば送ってあげる
+ 不要なファイル(キャッシュ済みのファイル)は送らない

### 中間レスポンス

* HTTP2からサポートした機能
* HTTP2では複数の中間レスポンス(Status code 100)と一つの最終レスポンス(Status code 200 et.al.)を送れる
* DBアクセスが発生するような重い処理中は中間レスポンスでjavascript/cssを送ってやり，処理完了ご最終レスポンスで結果を送る．

### CDNでのPush処理

* CDNによってやり方が異なる．
  * アクセスログを監視し，同じような要求があったら，同じようなレスポンスを返す
    * 機械学習的？
  * DSLを使う

### Cacheの検出方法

何がキャッシュされているか検出する必要がある．

* Cookiesベース
  * ブラウザの変更は必要ないので楽か
* Cacheダイジェスト
  * ブラウザ側の対応が必要
* 自分で作る
  * お勧めはできない

### その他

* 画像のpushはお勧めできない

## Q&A

* 中間レスポンスを用いた場合のベンチマークとかはないのか？
  * 中間レスポンスを使った場合のベンチマークはないが，Pushを使った場合のベンチマークはある．
  * 
